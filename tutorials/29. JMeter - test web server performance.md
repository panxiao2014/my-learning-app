# ðŸ“Š 29. JMeter - test web server performance

Now we have a web server running in the cloud, and we have two ways to access it:

* Access it directly through one of the running instances.
* Access it through web load balancer.

We might be interested in if the load balancer could help to improve web server performance by offloading traffic to two running distances. In this tutorial we'll use JMeter to do the test to compare the web server performance under the above two conditions.

After we install JMeter in our local host, we can open its GUI window. A default test plan exists in the left panel. I am going to do the test in the following way:

- Create two test groups within the same test plan, one for direct web access and one of load balancer test.

- Each test group would have exact the same test parameters, execpt the URL path.

- Add test summary in the test plan to compare test results from the groups.

For the default test plan that exists in the GUI, change its name to **Web Server Test Plan**. And enable option **Run Thread Groups consecutively**. This is because we want to compare their performance so we don't want to run them in parallel.

On the left panel, right click the test plan, add the first test group by selecting **Add --> Threads (Users) --> Thread Group**. Config this thread group by filling in the following:

>Name: Direct Access Thread Group
>
>Number of Threads (Users): 10
>
>Ramp-up period (seconds): 10
>
>Loop Count: 5

In the above configuration, we create ten users and each of them is running in a separate thread. These threads will be created within 10 seconds. Each thread will execute the test 5 times.

To define the HTTP request that we'll send to test the server, right click on this thread group, select **Add -> Config Element --> HTTP Request Defaults**. And then fill in the following:

>Name: Direct Access HTTP Request Defaults
>
>Protocol: http
>
>Server Name or IP: \<one of the IP address of the running instances, make sure you can access the web server by using this address\>
>
>Port Number: 80

Then we will add the HTTP request that will send to the server. Right click on this thread group, add HTTP request by selecting **Add --> Sampler --> HTTP Request**, fill in the following:

>Name: Direct Access HTTP Request
>
>Path: /api/randomUser

We should also add a cookie manager for this group: right click on this thread group, and select **Add -> Config Element --> HTTP Cookie Manager**

We can also add a timer to control the load of incoming traffic rate to the web server. Right click on this thread group, add a timer by selecting **Add -> Timer --> Uniform Random Timer**. And then fill in the following:

>Random Delay Maximum (in milliseconds): 100
>
>Constant Delay Offset (in milliseconds): 10

With the above timer setting, the delay between each request in a thread would be:

```
Delay = 10 + random(0 to 100) ms
```

Now we have the first test group ready, we can clone it to create the second group. Right click on this thread group, and select **Duplicate**. For the newly created group, we keep the test parameters unchanged so we can do the same test for this group and make comparison. Some of the paramters need to change:

Thread Group:
>Name: Load Balancer Thread Group

HTTP Request Defaults:
>Name: Load Balancer HTTP Request Defaults
>
>Protocol: https
>
>Server Name or IP: \<use the DNS name or the load balancer IP address\>
>
>Port Number: 443

HTTP Request:
>Name: Load Balancer HTTP Request

We have created the two test groups, now we need to add some components to show the test result. This is done through adding listener. We will add two listeners. First, right click on the test plan (not any of the test group), select **Add --> Listener --> View Result Trees**. This type of listener let us see if our HTTP request is succesfully handled by the web server. Then add another listener: **Aggregate Report**, the performance data will be shown in this listener.

To run this test, simply click the green run button on top of the window. We can click on **View Results Tree** we added to observe if any of the request sent failed. After test is over, click on **Aggregate Report**, we'll see the performance data for direct access and load balancer access.

There are few things to note:

- Every time before we start running the test, we should clear the previous test result. This could be done by selecting **Run --> Clear All**. Without doing this the result in Aggregate Report will merge all testing data in each test run together.

- When we start to run the test, JMeter will pop up a prompt to let us save the test plan, you can choose to save it for later use (Also, a Warning may appear syas "file already exist", this actually means a JMeter log file. You can choose to append log to this existing file, or overwrite it).

Now we have a valid test plan that could be executed, we can tweak load paramters to have real load test toward the web server. We can change the number of threads and loop count in Thread Group cofiguration, and delay time in Uniform Random Timer to increase traffic rate and parallel users for the test. Remember to keep the paramater the same in both thread group.

JMeter is also reminding us the GUI mode is only for test creation and debugging, we should use CLI mode for load test. After we save the test plan, we can execute test in CLI mode, for example:

```
jmeter -n -t mytests\web.jmx -l mytests\result.csv -e -o reports
```

The parameters above are explained here:

>n: run JMeter in CLI mode
>
>t: the test plan file we saved in GUI mode
>
>l: a path and file name to save the test result
>
>e: let JMeter generate a HTML report after test complete
>
>o: a folder for saving the HTML report (must be an empty folder).




