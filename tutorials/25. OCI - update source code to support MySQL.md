# ðŸ¬ 25. OCI - update source code to support MySQL

We used Postgresql server both in our local host and AWS in previous tutorials. Since Oracle Cloud provides free MySQL server so we can use it for the appliation.

First thing to consider: how to make our source code detect which database server is used. There are many ways to do this, I'll choose to use environment variables. To support MySQL server I'll define three variables:

>OCI_DATABASE_HOST
>
>OCI_DATABASE_USERNAME
>
>OCI_DATABASE_PASSWORD

We have hard coded Postgresql connection info in our source code. We need to update code to support constructing database connection URL based on different conditions. In **userdb_utils.py**, we can first update function **get_db_host()**, add the following code so it can return MySQL server address in OCI:

```
    #If running in Oracle Cloud, use OCI_DATABASE_HOSt defined in environment variable:
    if os.getenv("OCI_DATABASE_HOST"):
        print("ðŸ³ Detected OCI, using 'OCI_DATABASE_HOST'")
        return os.getenv("OCI_DATABASE_HOST")
```


Then import the following function:

```
from urllib.parse import quote_plus
```

And add the following two functions:

```
def read_database_password() -> str:
    """
    For OCI, read database password from environment variable.

    Otherwise, read PostgreSQL password from environment variable or file.
    
    Returns:
        str: The database password
    """
    if os.getenv("OCI_DATABASE_HOST"):
        return quote_plus(os.getenv("OCI_DATABASE_PASSWORD"))
    
    return quote_plus(read_postgres_password())


def get_database_url() -> str:
    """
    Construct the database URL. For now we will support PostgreSQL and MySQL.
    
    Returns:
        str: The database URL
    """
    try:
        db_host = get_db_host()
        password = read_database_password()

        if os.getenv("OCI_DATABASE_HOST"):
            username = os.getenv("OCI_DATABASE_USERNAME")
            return f"mysql+pymysql://{username}:{password}@{db_host}:3306/userdb"
        
        return f"postgresql+psycopg2://postgres:{password}@{db_host}:5432/userdb"
    
    except Exception as e:
        print(f"âŒ Error constructing database URL: {e}")
        sys.exit(1)
```

Function quote_plus() is used to escape any special character in password string.

Then for the rest part of the file, just use function **get_database_url()** to replace any code which uses hard code for database URL string.

To support MySQL we need to install another package:

```
pip install PyMySQL
```

Remember to update our Python requirements:

>cd backend
>
>pip freeze > requirements.txt

Also remember doing test to make sure our local and docker deployment won't have any regression issue after code update.

