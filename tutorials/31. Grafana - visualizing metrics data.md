# 31. Grafana - visualizing metrics data

In previous tutorial we used Prometheus and exporter to get system metrics. We need a GUI dashboard to customize any metrics we are interested. Grafana would be the good match for this purpose. In this tutorial we'll install and setup Grafana, then import data from Prometheus and create panels to display them.

We'll run a Grafana docker container. Like using Prometheus, we could create a folder for saving its config data:

```
mkdir ~/mygrafana
```

Then we start Grafana container:

```
docker run -p 3000:3000 --rm \
--name=grafana \
--network monitor-net \
-v ~/mygrafana/:/var/lib/grafana \
--user "$(id -u)" \
grafana/grafana-enterprise
```

To access Grafana portal, we need to update our security list. Just add an ingress rule for port 3000 in **metrics-security-list** that is created in previous tutorial.

Then we can access Grafana through port 3000 in web browser. The default user and password is "admin: admin", we can change password after log in.

Now we will add Prometheus as a data source for Grafana. In the left panel, navigate to **Connections --> Data sources --> Add data source**. There are a list of different types of sources, we choose **Prometheus**.

Give this datasource a name **myprometheus**.

In the configuration page, for the "Prometheus server URL", enter **http://prometheus:9090**. Note the "prometheus" here is the docker container name which is running Prometheus service. Since both grafana and prometheus containers are running in the same docker network "monitor-net", each could find the other one by the name. That is why we created the docker network in previous tutorial and use it for both containers.

For the other parameters, keep the default value. I only changed "Scrape interval" to 30s, which is the same as the value in my prometheus.yml.

Now we can click **Save & test**, make sure it shows **Successfully queried the Prometheus API.**, this means Grafana can pull data from our Prometheus source now.

To display metrics in the data source, we need to create a dashboard. A dashboard is a place where we can put different panels, each panel has a metric displayed. There are two ways to create a dashboard: from a template or create our own custom one.

We'll first try create it from template. Go to the [Grafana dashboard template web page](https://grafana.com/grafana/dashboards/). Here has rich set of dashboards. Search for **Node Exporter Full**. This is a dashboard just for Node Exporter. In its page, click **Download JSON**, the template config file will be downloaded.

Now go back to our Grafana page. In the top of the page, find the "+" symbol, click it and select **Import dashboard**. Here we can choose to upload the json file we downloaded. Then click **Import**.

Now we can see a page with rich set of metrics. On top of the page there are "Nodename" field which can let us choose between the two running instances. And there are many metrics which are groups into diffrent rows. We can fold or unfold each row to see the metrics. For example, in row "Quick CPU / Mem / Disk", we can have a quick view of system resources. Each metric is displayed in a panel. For each panel, we can click the three dots symbol and select **Edit**, then we can see how this metric is defined and how to config its display mode.

This dashborad from template is a good place to learn various configuration in Grafana. And we can also create a dashboard by our own. Since the above dashboard display metrics only for one running instance, and we need to switch it by Nodename to see the other. I want to have panels which could see both instances at the same time.

We are going to create a new dashboard by navigating to **Dashboards --> New --> New dashboard -->Add visualization**, and then select **myprometheus** as the data source.

For our first panel, let's add the most frequently used one: CPU busy percentage. In the box below the panel, we can define the query string by switching to **Code**, then input the following string:

```
100 * (1 - rate(node_cpu_seconds_total{mode="idle"}[$__rate_interval]))
```

Then we'll see four lines are displayed in the panel, which represent each CPU core in each instance. Let's try to understand the above query string.

**node_cpu_seconds_total{mode="idle"}** is the metric which is the CPU idle time in seconds. It is a counter type metric, which means its value will always increase. This is reasonable because its value is the total CPU idle time since the instance is up running.

rate() is a Prometheus function, it works on counter type metric so it could get the rate of that metric per second. It needs to specify a time range to calculate which is defined in the **[ ]** part. Here we use a Grafana variable **$__rate_interval** in stead of a hard coding value like 5m, 1h, etc. The benefit of using **$__rate_interval** is that Grafana will replace it with a time value based on the time range we select for dashboard observing, the width of the panel and the scrape time of Prometheus. So it will give us better display under these different situations.

Now we can continue to customize this panel. In the right side, we can edit the panel name, display style, value unit and many others. Remember we can always go back to the dashboard from template to see how it customizes each panel.

Once we have successfully added our first panel, we can have fun to add more panels for other metrics we like to see, with many display styles that Grafana provides. And remember to save the dashboard setting by click **Save dashboard** in top right of the page.
