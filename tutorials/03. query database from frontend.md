# üîç 03. query database from frontend

With database now managed by backend, we can query it from frontend. In this tutorial we'll add a web page for displaying user info. A user will be randomly selected from database and its info will be displayed.

Create or update these files in frontend:

Add a function in file **frontend/src/services/api.js**, it sends request to backend to get a user's info:

```
export async function getRandomUserApi() {
const res = await fetch("/api/randomUser");
if (!res.ok) {
    throw new Error("Failed to fetch random user");
}
return res.json();
}
```
Add file **frontend/src/hooks/userHooks.js**:
```
import { useState, useCallback } from "react";
import { getRandomUserApi } from "../services/api";


export function useRandomUser() {
  const [randomUser, setRandomUser] = useState(null);
  const [randomUserError, setError] = useState(null);

  const fetchRandomUser = useCallback(async () => {
    setError(null);
    try {
      const user = await getRandomUserApi();
      setRandomUser(user);
    } catch (e) {
      setError(e);
      setRandomUser(null);
    }
  }, []);

  return { randomUser, randomUserError, fetchRandomUser };
}
```

Add file **frontend/src/components/UserManagement.jsx**, this defines the UI for the new page:
```
import { useRandomUser } from "../hooks/userHook";

function UserManagement() {
  const { randomUser, randomUserError, fetchRandomUser } = useRandomUser();

  return (
    <div id="users-content" data-testid="users-content">
      <h1 className="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">Users Management</h1>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div id="display-user-section" className="p-4 border rounded-lg shadow-sm bg-white/60 dark:bg-gray-800/40" data-testid="display-user-area">
          <h2 className="text-lg font-semibold mb-4">Random User</h2>
          <div className="flex items-center gap-4 mb-4">
            <button
              onClick={fetchRandomUser}
              className="px-4 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition-colors duration-200"
            >
              Show me a user
            </button>
          </div>
          <div id="user-display-content" className="rounded-md border p-3 text-sm text-gray-800 dark:text-gray-100 min-h-[64px]" data-testid="user-display-content">
            {randomUserError ? (
              <div className="text-red-600">
                Error: {randomUserError.message}
              </div>
            ) : randomUser ? (
              <div>
                <div><span className="font-medium">Name:</span> {randomUser.name}</div>
                <div><span className="font-medium">Gender:</span> {randomUser.gender}</div>
                <div><span className="font-medium">Age:</span> {randomUser.age}</div>
              </div>
            ) : (
              <span>No user selected yet.</span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default UserManagement;
```

Update **frontend/src/App.jsx** to add new page:
```
import { useState } from "react";
import MainContent from "./components/MainContent";
import UserManagement from "./components/UserManagement";

function App() {
  const [activeTab, setActiveTab] = useState("main");

  return (
    <div className="min-h-screen flex">
      {/* Left Navigation Pane */}
      <div id="navigation-pane" data-testid="navigation-pane" className="w-64 bg-gray-100 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 p-4">
        <h2 className="text-lg font-semibold mb-6 text-gray-800 dark:text-gray-200">Navigation</h2>
        <nav className="space-y-2">
          <button
            id="main-nav-button"
            data-testid="main-nav-button"
            onClick={() => setActiveTab("main")}
            className={`w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 ${
              activeTab === "main"
                ? "bg-blue-500 text-white"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"
            }`}
          >
            Main
          </button>

          <button
            id="users-nav-button"
            data-testid="users-nav-button"
            onClick={() => setActiveTab("users")}
            className={`w-full text-left px-4 py-2 rounded-lg transition-colors duration-200 ${
              activeTab === "users"
                ? "bg-blue-500 text-white"
                : "text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"
            }`}
          >
            Users
          </button>
        </nav>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 p-4">
        {activeTab === "main" && <MainContent />}
        {activeTab === "users" && <UserManagement />}
      </div>
    </div>
  );
}

export default App;
```
To verify our UI update, refresh web page and the navigation pane now has a new item "Users". Click it and the new page will show. Click "Show me a user" and the page will display "Error: Failed to fetch random user". This is expected since we haven't update backend code to handle the request.

Update and add files in the backend to let it support frontend request:

Add file **backend/app/users/userdb_ops.py**:
```
from typing import Dict, Any, Optional
from sqlalchemy.orm import Session
from sqlalchemy import func
from .models import Users


def choose_ramdon_user(db: Session) -> Optional[Dict[str, Any]]:
    """
    Randomly select a user from the users table.
    Returns None if no users exist in the database.
    """
    # Get total count of users
    try:
        total_users = db.query(Users).count()
    except Exception as e:
        print(f"‚ö†Ô∏è Error getting total users: {e}")
        return None
    
    if total_users == 0:
        return None
    
    # Get a random user using OFFSET with random ordering
    random_user = db.query(Users).order_by(func.random()).first()
    
    if random_user:
        return {
            "name": random_user.name,
            "gender": random_user.gender,
            "age": random_user.age,
        }
    
    return None
```
Add file **backend/app/users/userdb_requests.py**:
```
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.orm import Session
from .userdb_ops import choose_ramdon_user


router = APIRouter()


def get_db(request: Request) -> Session:
    """Dependency to get database session"""
    return request.app.state.db_session_factory()


@router.get("/randomUser")
async def ramdon_user(db: Session = Depends(get_db)) -> dict:
    user = choose_ramdon_user(db)
    if user is None:
        raise HTTPException(status_code=404, detail="No users found in database")
    return user
```

Update **backend/app/main.py**:
```
from fastapi import FastAPI
from contextlib import asynccontextmanager
from fastapi.middleware.cors import CORSMiddleware
from app.config.config import TEST_PING
from app.users.userdb_utils import init_database_session, seed_database
from app.users.userdb_requets import router as userdb_router

@asynccontextmanager
async def lifespan(app: FastAPI):
    try:
        init_database_session(app)
    except Exception as e:
        print(f"‚ùå Failed to initialize database session: {e}")
        raise
    seed_database()
    try:
        yield
    finally:
        if hasattr(app.state, 'db_engine'):
            app.state.db_engine.dispose()

app = FastAPI(title="my-learning-app API", lifespan=lifespan)

# Allow frontend dev server
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # in production, restrict to your domain
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/ping")
async def ping():
    return {"message": TEST_PING}

app.include_router(userdb_router)
```

After this update, verify web page can now display a user randomly selected by clicking the button.