# ðŸ“ˆ 30. Prometheus - collecting metrics from host

In previous tutorial we have learnt using JMeter to do performance test for the web server. Besides this test, we also should have the ability to collect system metrics in real time. Prometheus is built for this purpose. In this tutorial we'll install and run Prometheus in our running instances.

Prometheus service itself does not collect data from system directly. It relies on "exporters" to do that job. An exporter is a running service that will collect metrics from various systems or applications. Prometheus then will be configured to read data from these exporters.

To monitor our system, we are going to add our first exporter: Node Exporter. It exposes a wide variety of hardware and kernel-related metrics. We have two running instances in Oracle Cloud, so we'll install this exporter on each of them.

To install and start the exporter service, simply run the following command:

```
wget https://github.com/prometheus/node_exporter/releases/download/v1.10.2/node_exporter-1.10.2.linux-amd64.tar.gz
tar xvfz node_exporter-1.10.2.linux-amd64.tar.gz
cd node_exporter-1.10.2.linux-amd64/
./node_exporter
```

After this exporter running, it will expose its collected data on port 9100. We can verify it by running:

```
curl http://localhost:9100/metrics
```

We'll see a list of various metrics.

Now we have Node Exporter running in both instances, we can proceed to install Prometheus for collecting metrics from these two exporters. We only need to install it in one of the hosts, it collects metrices from exporter running in local host and the other host.

First we need to add a security permission so the host can read data from the other host. Suppose we have Host1 and Host2. Our plan is to install Prometheus in Host1 so we first need to check if Host1 can read data from Host2. We can run command in Host1:

```
curl http://<Host2 IP address>:9100/metrics
```

This command will fail to connect to the destination port. So we need to switch to Host2, first check its iptable setting:

```
iptables -vL --line-numbers -n -t filter
```

Then we could add a rule to open TCP port 9100, for example:

```
iptables -I INPUT <line-number> -p tcp -s <Host1 IP address> --dport 9100 -j ACCEPT
```

The **\<line-number>** is the position to instert this rule. You should command **iptables -vL --line-numbers -n -t filter** to check your iptable output and decide which line should this rule be inserted.

Since we are running the instances in Oracle Cloud, we also need to add security permission to the virtual network. In the cloud console, navigate to **Networking --> Virtual Cloud Networks**, click on the VCN which has the instances running and switch to tab **Security**. Create a new security list, with the following configuration:

>Name: metrics-security-list

Add ingress rule:

>Source CIDR: \<Host1 IP address>/32
>
>IP Protocol: TCP
>
>Destination Port Range: 9100

This gives a minimum permission so Host2 only accept request from Host1 to port 9100. To apply this new list, switch to tab **Subnets**, click on the subnet where the instances are running. Switch to tab **Security**, here we can add the newly created security list.

Now back to Host1, run the command again:

```
curl http://<Host2 IP address>:9100/metrics
```
This time we'll see metrics data pulling from Host2.

We'll run Prometheus as a docker container. Before start the container I'll setup the configuration file for it.

First, create a folder:

```
mkdir ~/myprometheus
cd ~/myprometheus
```

I'll put the configuration file and metrics data all in this folder. Create another folder in it:

```
mkdir data
```
The metrics data will be saved to folder **data**.

Create a file **prometheus.yml**, with the following content:

```
global:
  scrape_interval: 30s

scrape_configs:
  - job_name: 'node_exporters'
    static_configs:
      - targets: ['10.0.0.118:9100']

      - targets: ['10.0.0.47:9100']
```

From this config file we could know:

- Prometheus will query metrics data every 30 seconds.
- It query data from two sources, which are the hosts that running Node Exporter

Please note, even Host1 has both exporter and Prometheus running, the above address for Host1 MUST be the IP address, not "localhost". This is because Prometheus is running in a docker container, "localhost" would refer to the container itself, where the container does not have the exporter running.

Also, since docker would access host's 9100 port through network stack, we need to add a iptable rule for the permission. We can add the permission just like we added in Host2 above. But for this one, we don't need to add rule in Oracle Cloud security list. This is because the traffic from Prometheus docker to host Node Exporter will not go into the cloud network, so there is no need for updating VCN security setting.

And we create a docker network:

```
docker network create monitor-net
```
We'll let the container run in this network.

Now we can start Prometheus server:

```
docker run --rm \
--name prometheus \
-p 9090:9090 \
--network monitor-net \
--user "$(id -u)" \
-v ~/myprometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
-v ~/myprometheus/data:/prometheus \
prom/prometheus \
--config.file=/etc/prometheus/prometheus.yml \
--storage.tsdb.path=/prometheus \
--storage.tsdb.retention.size=10GB
```

From this command we could know:

- Prometheus will open port 9090 so we can see all the metrics data it collects.
- We run the docker by the user as the current user, so it could have permission to write to ~/myprometheus/data
- It uses config file in folder ~/myprometheus
- It will save all metrics data to folder ~/myprometheus/data
- We set the database file size to 10GB

To check if Prometheus starts to work, we can run command:

```
curl http://localhost:9090/metrics
```

To further check if Prometheus is collecting data from both hosts, we could access its web console from our browser. We need to first update **metrics-security-list** we created above, add permission to port 9090. We don't need to update Host1 iptable for this port, because when the docker container started it will update iptable automatically for accessing tihs port.

Now open web browser and visit URL **http://\<Host1 IP address>:9090/query**. Input a query string and run it, for example:

```
node_cpu_seconds_total
```

Now we will see the output values. For example, one item may be:

```
node_cpu_seconds_total{cpu="0", instance="10.0.0.118:9100", job="node_exporters", mode="idle"}
```
This is to show the CPU idle time. We can see the exporter has used four labels for this item. These labels are very useful to identify each item.

Here are some other query sting we could try:

>node_cpu_seconds_total[2m]: check metric node_cpu_seconds_total value within 2 minutes
>
>node_cpu_seconds_total{instance="10.0.0.118:9100"}: check metric node_cpu_seconds_total value for a specific host
>
>node_cpu_seconds_total{instance="10.0.0.118:9100"}[2m]: combine the above two query conditions together





